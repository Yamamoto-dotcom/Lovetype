<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>LOVE TYPE｜診断結果</title>

<!-- Root=web 前提。APIは ./config.js で定義 -->
<script src="./config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

<style>
:root{
  --p1:#ffc5dd; --p2:#ffb9d4; --cream:#fff7ee; --ink:#111;
  --padX: 8%;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:#ffe9f4;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
.wrap{width:min(520px,94vw);margin:0 auto;padding:20px 0 32px}

/* 画面フレーム */
.screen{
  position:relative;width:100%;aspect-ratio:9/16;border-radius:28px;overflow:hidden;
  box-shadow:0 8px 24px rgba(0,0,0,.08);
  background:linear-gradient(180deg,var(--p1),var(--p2));
}
.panel{
  position:absolute;inset:0;border-radius:42px;margin:5% 4%;
  background:linear-gradient(180deg,var(--p2),var(--p1));
}

/* タイトル＋詳細ボタン */
.arc{position:absolute;top:7%;left:0;right:0;text-align:center;font-weight:900;color:#fff;
  text-shadow:0 3px 0 #ff8fbf;letter-spacing:.4em; z-index:2}
.link{position:absolute;right:calc(var(--padX) + 2%);top:6%;
  background:#fff;border-radius:999px;padding:8px 12px;font-weight:900;
  text-decoration:none;color:#333;border:3px solid #000; z-index:3}

/* レーダー領域（正方形） */
.radar-wrap{
  position:absolute; left:var(--padX); right:var(--padX); top:18%;
  /* 正方形を中央に固定。端末幅で自動調整 */
  width:auto; aspect-ratio:1 / 1; max-height:40%;
  margin:0 auto;
}
/* 背景の五角形（見た目だけ。キャンバスはクリップしない） */
.penta-bg{
  position:absolute; inset:6%;
  background:var(--cream);
  clip-path:polygon(50% 0%,100% 38%,80% 100%,20% 100%,0% 38%);
  z-index:1;
  border-radius:12px; /* 角をなめらかに */
}
/* レーダーキャンバスは全面に広げる */
.radar-box{
  position:absolute; inset:10%;
  z-index:2; /* 背景より前だが他要素より後ろにしない */
}
.radar-box canvas{width:100%;height:100%;display:block}

/* タイプ名のピル */
.bar{
  position:absolute; left:var(--padX); right:var(--padX); bottom:32%;
  height:48px; background:var(--cream); border-radius:999px;
  display:grid; place-items:center; font-weight:900; z-index:2;
}

/* 要約の吹き出し */
.bubble{
  position:absolute; right:calc(var(--padX) + 24%); bottom:9%; width:58%;
  min-height:16%; background:#fff; border:6px solid var(--ink); border-radius:22px;
  display:flex; align-items:center; justify-content:center; padding:12px 14px;
  text-align:center; font-weight:700; z-index:2;
}
.boy{position:absolute; left:calc(var(--padX) - 2%); bottom:6%; width:26%; pointer-events:none; z-index:1}

/* 端末が細い場合の保険 */
@media (max-width:420px){
  .radar-wrap{ inset: auto; left:var(--padX); right:var(--padX); top:18%; }
  .bubble{ right:calc(var(--padX) + 20%); width:60%; }
}
</style>
</head>
<body>
<main class="wrap">
  <section class="screen">
    <div class="panel"></div>

    <div class="arc" aria-hidden="true">診　断　結　果</div>
    <a id="toDetail" class="link" href="#">詳細を見る →</a>

    <!-- レーダーエリア -->
    <div class="radar-wrap">
      <div class="penta-bg" aria-hidden="true"></div>
      <div class="radar-box"><canvas id="radar" aria-label="5指標レーダー"></canvas></div>
    </div>

    <div id="typeBar" class="bar">相性タイプ：—</div>
    <div id="summary" class="bubble">—</div>
    <img class="boy" src="./img/char-boy.PNG" alt="キャラクター">
  </section>
</main>

<script>
const API = (window.API_BASE||'').replace(/\/+$/,'');
const q  = new URL(location.href).searchParams;
const a  = q.get('a'), b = q.get('b');
if(!a || !b){ location.replace('./index.html'); }

async function fetchScore(a,b){
  let r = await fetch(API+'/score',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({typeA:a,typeB:b})});
  let j = await r.json();
  if(!r.ok){
    r = await fetch(API+'/score',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({a,b})});
    j = await r.json();
    if(!r.ok) throw new Error(j.detail||'score error');
  }
  return j;
}

function scoresToArray(payload){
  const s = payload.scores || {};
  const get = (...keys) => {
    for (const k of keys) if (s[k] !== undefined && s[k] !== null && s[k] !== '') return +s[k];
    return 0;
  };
  const arr = [ get('empathy','共感'), get('harmony','調和'), get('dependence','依存'),
                get('stimulation','刺激'), get('trust','信頼') ];
  return arr.map(v => (v > 1 ? v/100 : v)); // 60→0.6
}

(async ()=>{
  try{
    const p = await fetchScore(a,b);
    // ピル＆要約
    document.getElementById('typeBar').textContent = '相性タイプ：' + (p.label || p?.micro?.type || '—');
    document.getElementById('summary').textContent = p.summary || p?.copy?.catch || '—';
    document.getElementById('toDetail').href = `./detail.html?a=${encodeURIComponent(a)}&b=${encodeURIComponent(b)}`;

    // レーダー
    const ctx = document.getElementById('radar').getContext('2d');
    new Chart(ctx,{
      type:'radar',
      data:{
        labels:['共感','調和','依存','刺激','信頼'],
        datasets:[{
          data: scoresToArray(p),
          fill: true,
          pointRadius: 0,
          borderWidth: 2,
          borderColor: 'rgba(255,105,180,0.95)',
          backgroundColor: 'rgba(255,105,180,0.25)'
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,            // ← ラッパの正方形にフィット
        layout:{ padding:18 },                // ← 端の食い込み防止
        plugins:{ legend:{ display:false } },
        elements:{ line:{ tension:0 } },
        scales:{ r:{
          min:0, max:1, beginAtZero:true,
          ticks:{ display:false },
          grid:{ circular:true, color:'rgba(0,0,0,0.06)' },
          angleLines:{ color:'rgba(0,0,0,0.06)' },
          pointLabels:{ color:'#6b5a68', font:{ size:12 }, padding:10 }
        }}
      }
    });
  }catch(e){
    alert('通信エラー：結果を取得できませんでした');
  }
})();
</script>
</body>
</html>
