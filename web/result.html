<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>LOVE TYPE｜診断結果</title>

<!-- Root=web 前提。APIのURLは ./config.js で定義 -->
<script src="./config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

<style>
:root{ --p1:#ffc5dd; --p2:#ffb9d4; --cream:#fff7ee; --ink:#111 }
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:#ffe9f4;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
.wrap{width:min(520px,94vw);margin:0 auto;padding:20px 0 32px}
.screen{position:relative;width:100%;aspect-ratio:9/16;border-radius:28px;overflow:hidden;
  box-shadow:0 8px 24px rgba(0,0,0,.08);background:linear-gradient(180deg,var(--p1),var(--p2))}
.panel{position:absolute;inset:0;border-radius:42px;margin:5% 4%;
  background:linear-gradient(180deg,var(--p2),var(--p1))}
.arc{position:absolute;top:7%;left:0;right:0;text-align:center;font-weight:900;color:#fff;
  text-shadow:0 3px 0 #ff8fbf;letter-spacing:.4em}
.penta{position:absolute;left:17%;top:18%;width:66%;height:38%;background:var(--cream);
  clip-path:polygon(50% 0%,100% 38%,80% 100%,20% 100%,0% 38%)}
.radar{position:absolute;inset:10% 10% 8% 10%}
.bar{position:absolute;left:12%;right:12%;bottom:32%;height:5.4%;background:var(--cream);
  border-radius:999px;display:grid;place-items:center;font-weight:900}
.bubble{position:absolute;right:6%;bottom:9%;width:62%;min-height:16%;background:#fff;
  border:6px solid var(--ink);border-radius:22px;display:flex;align-items:center;justify-content:center;
  padding:12px 14px;text-align:center;font-weight:700}
.boy{position:absolute;left:4%;bottom:5%;width:30%;pointer-events:none}
.link{position:absolute;right:6%;top:6%;background:#fff;border-radius:999px;padding:8px 12px;
  font-weight:900;text-decoration:none;color:#333;border:3px solid #000}
</style>
</head>
<body>
<main class="wrap">
  <section class="screen">
    <div class="panel"></div>
    <div class="arc" aria-hidden="true">診　断　結　果</div>

    <div class="penta"><canvas id="radar" class="radar" aria-label="5指標レーダー"></canvas></div>
    <div id="typeBar" class="bar">相性タイプ：—</div>
    <div id="summary" class="bubble">—</div>

    <img class="boy" src="./img/char-boy.PNG" alt="キャラクター">
    <a id="toDetail" class="link" href="#">詳細を見る →</a>
  </section>
</main>

<script>
const API = (window.API_BASE||'').replace(/\/+$/,'');
const q = new URL(location.href).searchParams;
const a = q.get('a'), b = q.get('b');
if(!a || !b){ location.replace('./index.html'); }

// /score を旧( {typeA,typeB} )→新( {a,b} ) の順に試す
async function fetchScore(a,b){
  let r = await fetch(API+'/score',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({typeA:a,typeB:b})});
  let j = await r.json();
  if(!r.ok){
    r = await fetch(API+'/score',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({a,b})});
    j = await r.json();
    if(!r.ok) throw new Error(j.detail||'score error');
  }
  return j;
}

// ←ここがポイント：英語/日本語どちらのキーでも値を拾い、%→0–1に正規化
function scoresToArray(payload){
  const s = payload.scores || {};
  const get = (...keys) => {
    for (const k of keys) {
      if (s[k] !== undefined && s[k] !== null && s[k] !== '') return +s[k];
    }
    return 0;
  };
  const arr = [
    get('empathy','共感'),
    get('harmony','調和'),
    get('dependence','依存'),
    get('stimulation','刺激'),
    get('trust','信頼')
  ];
  return arr.map(v => (v > 1 ? v/100 : v)); // 60 → 0.6 に
}

(async()=>{
  try{
    const p = await fetchScore(a,b);

    // タイプ名＆要約
    document.getElementById('typeBar').textContent = '相性タイプ：' + (p.label || p?.micro?.type || '—');
    document.getElementById('summary').textContent = p.summary || p?.copy?.catch || '—';

    // レーダー描画
    const ctx = document.getElementById('radar');
    new Chart(ctx,{
      type:'radar',
      data:{
        labels:['共感','調和','依存','刺激','信頼'],
        datasets:[{
          data: scoresToArray(p),
          fill: true,
          pointRadius: 0,
          borderWidth: 2,
          borderColor: 'rgba(255,105,180,0.95)',
          backgroundColor: 'rgba(255,105,180,0.25)'
        }]
      },
      options:{
        responsive:true,
        plugins:{ legend:{ display:false } },
        scales:{ r:{
          min:0, max:1, beginAtZero:true,
          ticks:{ display:false },
          grid:{ circular:true }
        }}
      }
    });

    // 詳細へリンク
    document.getElementById('toDetail').href =
      `./detail.html?a=${encodeURIComponent(a)}&b=${encodeURIComponent(b)}`;
  }catch(e){
    alert('通信エラー：結果を取得できませんでした');
  }
})();
</script>
</body>
</html>
})();
</script>
</body>
</html>
</body>
</html>
